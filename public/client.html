<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <script src="jquery-2.0.3.min.js"></script>
        <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <link rel="stylesheet" href="normalize.css" type="text/css" media="all">
        <link rel="stylesheet" href="common.css" type="text/css" media="all">
        <title>Crosspoint</title>
    </head>
    <body>
        <div id="header-bar">
            <img id="logo" width="32" height="32" src="logo.svg"/>
            <label>表示名: <input type="text" id="screen-name-entry" placeholder="任意" /></label>
            &nbsp;
            <label>学籍番号: <input type="text" id="student-id-entry" placeholder="必須" /></label>
        </div>

        <div id="column-container">
            <div class="column">
                <div class="view_title">
                    <div id="group_name">
                        <h3>あなたのグループ内のメッセージ</h3>
                    </div>
                </div>
                <div id="group_posts" class="view">
                  <textarea class="comment-entry" id="group-comment-entry" placeholder="書き込む..." autofocus></textarea>
                </div>
            </div>

            <div class="column-mini">
                <div class="view_title">
                    <h3>TAからのメッセージ</h3>
                </div>
                <div id="ta_posts" class="view">
                </div>
            </div>

            <div class="column-half">
                <div class="view_title">
                    <h3>全体のメッセージ</h3>
                </div>
                <div id="posts" class="view">
                    <textarea class="comment-entry" id="comment-entry" placeholder="書き込む..." autofocus></textarea>
                </div>
            </div>
        </div>

        <script>
            $(function() {
                function updateSlideClasses() {
                    $('.slide.current').prevAll('.slide').removeClass('prev left');
                    $('.slide.current').nextAll('.slide').removeClass('next right');

                    $('.slide.current').prevAll('.slide').addClass('left');
                    $('.slide.current').nextAll('.slide').addClass('right');

                    $('.slide.current').prev('.slide').addClass('prev');
                    $('.slide.current').next('.slide').addClass('next');
                }

                function goToPrevSlide() {
                    if ($('.slide.current').prev('.slide').length > 0) {
                        $('.slide.current').removeClass('current');
                        $('.slide.prev').addClass('current');
                        $('.slide.prev').removeClass('prev left');

                        updateSlideClasses();
                    }
                }

                function goToNextSlide() {
                    if ($('.slide.current').next('.slide').length > 0) {
                        $('.slide.current').removeClass('current');
                        $('.slide.next').addClass('current');
                        $('.slide.next').removeClass('next right');

                        updateSlideClasses();
                    }
                }

                // Utility functions for handling cookies
                function parseCookies(def) {
                    def = def || {};
                    var cookies = {};
                    $.each(document.cookie.split(";"), function(_, param) {
                        var kv = param.split("=");
                        var k = decodeURIComponent(kv[0]);
                        var v = decodeURIComponent(kv[1]);
                        cookies[k] = v;
                    });
                    return $.extend(true, {}, def, cookies);
                }

                function getCookie(key) {
                    $.each(document.cookie.split(";"), function(_, param) {
                        var kv = param.split("=");
                        if (decodeURIComponent(kv[0]) === key) {
                            return decodeURIComponent(kv[1]);
                        }
                    });
                    return null;
                }

                function setCookie(k, v, opts) {
                    opts = opts || {};

                    var opts_str = "";
                    $.each(opts, function(k, v) {
                        opts_str += "; " + k + "=" + v;
                    });

                    document.cookie = encodeURIComponent(k) + "=" + encodeURIComponent(v) + opts_str;
                }

                function removeCookie(k) {
                    setCookie(k, "", { expires: "Thu, 01 Jan 1970 00:00:00 GMT" });
                }

                // Set/get the serial numbers of users
                function writeToStorage(key, value) {
                    if (window.localStorage) {
                        window.localStorage[key] = JSON.stringify(value);
                    }

                    setCookie(key, JSON.stringify(value));
                }

                function readFromStorage(key) {
                    if (window.localStorage && typeof(window.localStorage[key]) !== "undefined") {
                        return JSON.parse(window.localStorage[key]);
                    }
                    else {
                        return JSON.parse(getCookie(key));
                    }
                }

                function isInvalid(x) {
                    return x === null || typeof(x) === "undefined";
                }

                function formatPostDate(d) {
                    return d.getFullYear()    + "年"
                         + (d.getMonth() + 1) + "月"
                         + d.getDate()        + "日"
                         + d.getHours()       + "時"
                         + d.getMinutes()     + "分"
                         + d.getSeconds()     + "秒";
                }

                function renderPost(post) {
                    var content = post.content.replace(/\#GROUP-ONLY/ig, "");
                    return '<div class="post">\
                              <div class="header">\
                                <span class="number">' + post.number + '</span>\
                                <span class="time">' + formatPostDate(new Date(post.time)) + '</span>\
                                <span class="host">\
                                  <span class="host-name">' + (post.user.screen_name || "NO NAME") + '</span>\
                                  &nbsp;\
                                  <span class="ip-addr">(' + post.user.user_id + ')</span>\
                                </span>\
                              </div>\
                              <div class="content">' + content + '</div>\
                            </div>';
                }

                var new_posts = [];
                function showPost(post) {
                    var uid = readFromStorage('user_id');
                    var gid = readFromStorage('group_id');
                    if (post.content.match(/#GROUP-ONLY/i)) {
                        if (gid === post.user.group_id) {
                            var p = $(renderPost(post));
                            MathJax.Hub.Queue(["Typeset", MathJax.Hub, p[0]]);
                            p.insertAfter('#group_posts > .comment-entry');
                        }
                    }
                    else {
                        var p = $(renderPost(post));
                        MathJax.Hub.Queue(["Typeset", MathJax.Hub, p[0]]);
                        if (post.user.user_id === uid) {
                            $('#new_msg_notification').click();
                            p.insertAfter('#posts > .comment-entry');
                        }
                        else {
                            new_posts.push(p);
                            if ($('#new_msg_notification').length == 0) {
                                $('<div id="new_msg_notification"></div>').insertAfter('#posts > .comment-entry');
                                $('#new_msg_notification').on('click', function(e) {
                                    $.each(new_posts, function(_, new_post) {
                                        new_post.insertAfter('#posts > .comment-entry');
                                    });
                                    new_posts = [];
                                    $(this).remove();
                                });
                            }
                            $('#new_msg_notification').text(new_posts.length + '件の新着');
                        }
                    }
                }

                var ws = null;
                function startWebSocket() {
                    var hostname = window.location.hostname;
                    ws = new WebSocket("ws://" + hostname + ":9090/");

                    ws.onopen = function(){
                        var uid = readFromStorage('user_id');
                        var gid = readFromStorage('group_id');
                        console.log("My user ID is: \"" + uid + "\"");
                        console.log("My group ID is: \"" + gid + "\"");
                        if (isInvalid(uid)) {
                            var msg = { type: 'need-both-ids' };
                            ws.send(JSON.stringify(msg));
                        }
                        else if (isInvalid(gid)) {
                            var msg = { type: 'need-group-id', 'user_id': uid };
                            ws.send(JSON.stringify(msg));
                        }
                    };

                    ws.onmessage = function(e) {
                        var msg = JSON.parse(e.data);
                        if (msg.type === "prev") {
                            goToPrevSlide();
                        }
                        else if (msg.type === "next") {
                            goToNextSlide();
                        }
                        else if (msg.type === "post") {
                            showPost(msg);
                        }
                        else if (msg.type === "archived-posts") {
                            msg.posts.forEach(showPost);
                            $('#new_msg_notification').click();
                        }
                        else if (msg.type === "post-ta") {
                            var p = $(renderPost(msg));
                            MathJax.Hub.Queue(["Typeset", MathJax.Hub, p[0]]);
                            p.appendTo('#ta_posts');
                        }
                        else if (msg.type === "user-id") {
                            writeToStorage('user_id', msg.user_id);
                        }
                        else if (msg.type === "group-id") {
                            writeToStorage('group_id', msg.group_id);
                        }
                        else if(msg.type == "aux-data") {
                            $("#student-id-entry").val(msg.student_id);
                            $("#screen-name-entry").val(msg.screen_name);
                        }
                        else if (msg.type === "draw") {
                            var ctx = $('.slide.current > canvas.overlay')[0].getContext('2d');
                            if (msg.shape === "line") {
                                ctx.strokeStyle = 'black';
                                ctx.lineWidth = 4;
                                ctx.lineCap = 'round';
                                ctx.lineJoin = 'round';

                                var last_pos = msg.from;
                                var pos = msg.to;
                                ctx.moveTo(last_pos.x, last_pos.y);
                                ctx.lineTo(pos.x, pos.y);
                                ctx.stroke();
                            }
                        }
                    };
                    ws.onclose = function() {
                        setTimeout(function() { startWebSocket(); }, 0);
                    };
                }
                startWebSocket();

                $.get('slide.html', function(data) {
                    $('#view').html(data);

                    $('.slide').first().addClass('current');
                    $('.slide').append('<canvas class="overlay"></canvas>');
                    $.each($('.slide > canvas.overlay'), function(i, canvas) {
                        canvas.width = $(canvas).parent().width();
                        canvas.height = $(canvas).parent().height();
                    });

                    updateSlideClasses();
                });

                $('#comment-entry').on('keypress', function(e) {
                    if (!e.ctrlKey && e.which === 13) {
                        var s = $(this).val();
                        if (s.length > 0) {
                            var uid = readFromStorage('user_id');
                            var msg = { 'type': 'post', 'content': s , 'user_id': uid};
                            ws.send(JSON.stringify(msg));
                            $(this).val('');
                        }
                        e.preventDefault();
                    }
                    else if (e.which === 10 || (e.ctrlKey && e.which === 13)) {
                        var s = $(this).val();
                        var start = this.selectionStart;
                        var end = this.selectionEnd;
                        $(this).val(s.slice(0, start) + "\n" + s.slice(end));
                        this.selectionStart = start + 1;
                        this.selectionEnd = start + 1;
                    }
                });

                 $('#group-comment-entry').on('keypress', function(e) {
                    if (!e.ctrlKey && e.which === 13) {
                        var s = $(this).val();
                        if (s.length > 0) {
                            var uid = readFromStorage('user_id');
                            var msg = { 'type': 'post', 'content': s + "#GROUP-ONLY", 'user_id': uid};
                            ws.send(JSON.stringify(msg));
                            $(this).val('');
                        }
                        e.preventDefault();
                    }
                    else if (e.which === 10 || (e.ctrlKey && e.which === 13)) {
                        var s = $(this).val();
                        var start = this.selectionStart;
                        var end = this.selectionEnd;
                        $(this).val(s.slice(0, start) + "\n" + s.slice(end));
                        this.selectionStart = start + 1;
                        this.selectionEnd = start + 1;
                    }
                });
                $('#screen-name-entry').val(readFromStorage('screen_name'));
                $('#student-id-entry').val(readFromStorage('student_id'));
                $('#screen-name-entry').on('input', function(e) {
                    var s = $(this).val();
                    if (s.length === 0) {
                        s = null;
                    }
                    var uid = readFromStorage('user_id');
                    var msg = { 'type': 'change-screen-name', 'user_id': uid, 'screen_name': s };
                    ws.send(JSON.stringify(msg));
                    writeToStorage('screen_name', s)
                });
                $('#student-id-entry').on('input', function(e) {
                    var s = $(this).val();
                    if (s.length === 0) {
                        s = null;
                    }
                    var uid = readFromStorage('user_id');
                    var msg = { 'type': 'change-student-id', 'user_id': uid , 'student_id': s };
                    ws.send(JSON.stringify(msg));
                    writeToStorage('student_id', s)
                });
            });
        </script>
    </body>
</html>
