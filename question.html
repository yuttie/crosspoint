<html lang="en">
    <head>
        <meta charset="UTF-8">
        <script src="jquery-1.9.0.js"></script>
        <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <title></title>
    </head>
    <body>
        <div id="user_id" style="text-align:center"></div>

        <!-- 質問事項 -->
        <div id="QUESTION-FORM" style="height:80%; width:80%;">
            <div style="height:100%; width:100%">
                <form id="question1" style="border-style:double;">
                    Q1.MP3をもっているか
                    <p>
                    <input type="radio" name="choices" value="#qMP3_0">持っている
                    <input type="radio" name="choices" value="#qMP3_1">持っていない
                    </p>
                    <input type="button" class="question-send" id="question1" value="送信">
                </form>

                 <form id="question2" style="border-style:double;">
                    Q2.IPアドレスを知っているか
                    <p>
                    <input type="radio" name="choices" value="#qIP_0">知っている
                    <input type="radio" name="choices" value="#qIP_1">知らない
                    </p>
                    <input type="button" class="question-send" id="question2" value="送信">
                </form>

                <form id="question3" style="border-style:double;">
                    Q3.TCP/IPを知っているか
                    <p>
                    <input type="radio" name="choices" value="#qTCP/IP_0">知っている
                    <input type="radio" name="choices" value="#qTCP/IP_1">知らない
                    </p>
                    <input type="button" class="question-send" id="question3" value="送信">
                </form>

            </div>
        </div>
 
        <script>
            $(function() {

                // クライアントにCookieを保存する
                function setCookie(num){
                    var s = "";
                    s = 'cookie_name={"serial_number":"' + num + '"};';
                    var expire = new Date();
                    expire.setTime( expire.getTime() + 1000 * 3600 * 24 );
                    s = s + 'expires=' + expire.toUTCString() + ';';
                    document.cookie = s;
                }
                // 該当するCookieを読み込む
                function getCookie(){
                    var result = new Array();
                    if(document.cookie.length > 0){
                        var all_cookie = document.cookie;
                        if(all_cookie != ''){
                            cookies = all_cookie.split(';');
                            for(var i = 0; i < cookies.length; i++){
                                var cookie = cookies[i].split("=");
                                result[cookie[0]] = decodeURIComponent(cookie[1]);
                            }
                        }
                        var json = JSON.parse(result['cookie_name']);
                        return json.serial_number;
                    }
                }

                var ws = null;
                function startWebSocket() {
                    ws = new WebSocket("ws://" + window.location.hostname + ":9090/");
                    /*
                    ws.onopen = function(){
                        var unique_id = getCookie();
                        var msg = "";
                        // console.log(typeof(getCookie()));

                        if(typeof(unique_id) !== "undefined"){
                            msg = {'type': 'cookie', 'unique_id': unique_id};
                            var gname = getUserID(unique_id);
                            document.getElementById("group_name").innerHTML = "<h3>グループ No." + gname + " の投稿</h3>";
                        }else{
                            msg = {'type': 'cookie', 'unique_id': "TA"};
                        }

                        ws.send(JSON.stringify(msg));
                    };
                    */
                    ws.onmessage = function(e) {
                        var msg = JSON.parse(e.data);
                        if (msg.type === "cookie") {
                            setCookie(msg.serial_num);
                            var gname = getUserID(msg.serial_num);
                            document.getElementById("group_name").innerHTML = "<h3>グループ No." + gname + " の投稿</h3>";
                        }else if(msg.type == "user_data"){
                            document.getElementById("user_id").innerHTML = "ようこそ" + msg.user_name + "さん<br>あなたの学生番号は " + msg.user_id + " です";
                        }
                        else if (msg.type === "draw") {
                            var ctx = $('.slide.current > canvas.overlay')[0].getContext('2d');
                            if (msg.shape === "line") {
                                ctx.strokeStyle = 'black';
                                ctx.lineWidth = 4;
                                ctx.lineCap = 'round';
                                ctx.lineJoin = 'round';

                                var last_pos = msg.from;
                                var pos = msg.to;
                                ctx.moveTo(last_pos.x, last_pos.y);
                                ctx.lineTo(pos.x, pos.y);
                                ctx.stroke();
                            }
                        }
                    };
                    ws.onclose = function() {
                        setTimeout(function() { startWebSocket(); }, 0);
                    };
                }
                startWebSocket();

                // アンケートの受信
                $('.question-send').click(function(e){
                    var btnid  = $(this).attr("id");
                    var val = $('#'+btnid+' [name=choices]:checked').val();
                    if(typeof(val) !== 'undefined'){
                        var id = getCookie();
                        var msg = { 'type': 'question', 'body': val , 'id':id};
                        ws.send(JSON.stringify(msg));
                    }
                });
            });
        </script>
    </body>
</html>